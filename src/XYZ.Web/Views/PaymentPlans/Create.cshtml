@using XYZ.Web.Models.PaymentPlans
@model CreatePaymentPlanVm
@{
    ViewData["Title"] = "Aidat Planı Oluştur";
    var studentName = string.IsNullOrWhiteSpace(Model.StudentFullName) ? "Öğrenci" : Model.StudentFullName;
    var hasActivePlan = (ViewBag.ActivePlanExists as bool?) == true;
    var unpaidCount = (int)(ViewBag.ActivePlanUnpaidCount ?? 0);

}

<section class="mb-3 d-flex justify-content-between align-items-center gap-2">
    <div>
        <a asp-controller="PaymentPlans"
           asp-action="Student"
           asp-route-studentId="@Model.StudentId"
           class="text-muted small text-decoration-none">
            &larr; Aidat planına dön
        </a>
        <h2 class="h4 mb-0 mt-1">Aidat Planı Oluştur</h2>
        <div class="text-muted small">Öğrenci için aidat planı ve taksitleri oluşturun.</div>
    </div>

    <a asp-controller="PaymentPlans"
       asp-action="Student"
       asp-route-studentId="@Model.StudentId"
       class="btn btn-sm btn-outline-secondary d-none d-md-inline-flex">
        Vazgeç
    </a>
</section>

@if (hasActivePlan)
{
    <div class="alert alert-warning small">
        Bu öğrenci için <strong>aktif bir aidat planı</strong> mevcut.
        Kaydetmeniz halinde mevcut plan <strong>Arşivlenecek</strong> ve ödenmemiş <strong>@unpaidCount</strong> taksit <strong>İptal</strong> edilecektir.
    </div>
}

<form asp-action="Create" method="post" id="planForm">
    @Html.AntiForgeryToken()
    <input type="hidden" asp-for="StudentId" />

    <div class="row g-3">
        <!-- LEFT: Form -->
        <div class="col-lg-8">
            <section class="card-surface">
                <div class="card-body">
                    <div asp-validation-summary="ModelOnly" class="text-danger small mb-3"></div>

                    <div class="mb-3">
                        <label class="form-label">Öğrenci</label>
                        <div class="p-2 border rounded bg-white text-dark">
                            <span class="fw-semibold">@studentName</span>
                        </div>
                    </div>

                    <div class="row g-3">
                        <div class="col-md-6">
                            <label asp-for="TotalAmount" class="form-label">Toplam Tutar</label>
                            <div class="input-group">
                                <span class="input-group-text">₺</span>
                                <input asp-for="TotalAmount" class="form-control bg-white text-dark" inputmode="decimal" />
                            </div>
                            <span asp-validation-for="TotalAmount" class="text-danger small"></span>
                        </div>

                        <div class="col-md-6">
                            <label asp-for="FirstDueDate" class="form-label">İlk Vade Tarihi</label>
                            <input asp-for="FirstDueDate"
                                   class="form-control bg-white text-dark"
                                   type="date"
                                   value="@(Model.FirstDueDate == default ? DateTime.Today.ToString("yyyy-MM-dd") : Model.FirstDueDate.ToString("yyyy-MM-dd"))" />
                            <span asp-validation-for="FirstDueDate" class="text-danger small"></span>
                        </div>

                        <div class="col-12">
                            <label class="form-label">Plan Tipi</label>
                            <div class="d-flex flex-wrap gap-2">
                                <input class="btn-check" type="radio" id="plan-pesin" name="IsInstallment" value="false" @(Model.IsInstallment ? null : "checked") />
                                <label class="btn btn-outline-secondary" for="plan-pesin">Peşin</label>

                                <input class="btn-check" type="radio" id="plan-taksit" name="IsInstallment" value="true" @(Model.IsInstallment ? "checked" : null) />
                                <label class="btn btn-outline-secondary" for="plan-taksit">Aylık Taksitli</label>
                            </div>
                            <div class="form-text">Peşin seçerseniz tek kalem oluşturulur. Taksitli seçerseniz aylık taksitler üretilir.</div>
                        </div>

                        <div class="col-md-6">
                            <label asp-for="TotalInstallments" class="form-label">Taksit Sayısı</label>
                            <input asp-for="TotalInstallments"
                                   class="form-control bg-white text-dark"
                                   id="installmentsInput"
                                   min="1" />
                            <span asp-validation-for="TotalInstallments" class="text-danger small"></span>
                        </div>

                        <!-- Mobile preview (collapsible look) -->
                        <div class="col-12 d-lg-none">
                            <div class="p-3 border rounded bg-white text-dark">
                                <div class="d-flex justify-content-between align-items-start gap-2">
                                    <div>
                                        <div class="fw-semibold">Önizleme</div>
                                        <div class="small text-muted">Yaklaşık taksit tutarı</div>
                                    </div>
                                    <div class="fs-5 fw-semibold" id="previewInstallment_m">-</div>
                                </div>

                                <div class="small text-muted mt-2">
                                    Bu hesap sadece toplam tutar / taksit sayısına göredir.
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Actions -->
                    <div class="d-flex justify-content-end gap-2 mt-4 d-none d-md-flex">
                        <a asp-controller="PaymentPlans"
                           asp-action="Student"
                           asp-route-studentId="@Model.StudentId"
                           class="btn btn-outline-secondary">
                            Vazgeç
                        </a>
                        <button type="submit" class="btn btn-primary">Kaydet</button>
                    </div>
                </div>
            </section>

            <!-- Mobile sticky actions -->
            <div class="d-md-none position-sticky bottom-0 start-0 end-0 bg-white border-top mt-3" style="z-index: 1020;">
                <div class="container-fluid py-2">
                    <div class="d-flex gap-2">
                        <a asp-controller="PaymentPlans"
                           asp-action="Student"
                           asp-route-studentId="@Model.StudentId"
                           class="btn btn-outline-secondary">
                            Vazgeç
                        </a>
                        <button type="submit" class="btn btn-primary flex-fill">Kaydet</button>
                    </div>
                </div>
            </div>
            <div class="d-md-none" style="height:80px;"></div>
        </div>

        <!-- RIGHT: Desktop preview -->
        <div class="col-lg-4 d-none d-lg-block">
            <section class="card-surface position-sticky" style="top: 88px;">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-start gap-2 mb-2">
                        <div>
                            <div class="fw-semibold">Önizleme</div>
                            <div class="small text-muted">Yaklaşık taksit tutarı</div>
                        </div>
                        <div class="fs-4 fw-semibold" id="previewInstallment">-</div>
                    </div>

                    <hr class="my-3" />

                    <div class="small text-muted mb-2">Özet</div>
                    <div class="vstack gap-2">
                        <div class="d-flex justify-content-between">
                            <span class="text-muted">Toplam</span>
                            <span class="fw-semibold" id="previewTotal">-</span>
                        </div>
                        <div class="d-flex justify-content-between">
                            <span class="text-muted">Taksit</span>
                            <span class="fw-semibold" id="previewCount">-</span>
                        </div>
                        <div class="d-flex justify-content-between">
                            <span class="text-muted">İlk Vade</span>
                            <span class="fw-semibold" id="previewFirstDue">-</span>
                        </div>
                        <div class="d-flex justify-content-between">
                            <span class="text-muted">Tip</span>
                            <span class="fw-semibold" id="previewType">-</span>
                        </div>
                    </div>

                    <div class="small text-muted mt-3">
                        Bu bölüm bilgilendirme amaçlıdır. Kesin tutar ve vade listesi oluşturma sonrası belirlenir.
                    </div>
                </div>
            </section>
        </div>
    </div>
</form>

<script>
    (function () {
        const pesin = document.getElementById('plan-pesin');
        const taksit = document.getElementById('plan-taksit');
        const installmentsInput = document.getElementById('installmentsInput');
        const totalAmount = document.getElementById('TotalAmount');
        const firstDue = document.getElementById('FirstDueDate');

        const prevDesktop = document.getElementById('previewInstallment');
        const prevMobile = document.getElementById('previewInstallment_m');

        const prevTotal = document.getElementById('previewTotal');
        const prevCount = document.getElementById('previewCount');
        const prevFirstDue = document.getElementById('previewFirstDue');
        const prevType = document.getElementById('previewType');

        function parseNumber(val) {
            if (!val) return 0;
            const normalized = ('' + val).replace(',', '.');
            const n = Number(normalized);
            return isNaN(n) ? 0 : n;
        }

        function formatTry(n) {
            if (!n || n <= 0) return '-';
            try {
                return n.toLocaleString('tr-TR', { style: 'currency', currency: 'TRY' });
            } catch {
                return n.toFixed(2);
            }
        }

        function updateInstallmentsState() {
            if (pesin.checked) {
                installmentsInput.value = 1;
                installmentsInput.setAttribute('readonly', 'readonly');
                installmentsInput.classList.add('bg-light');
            } else {
                installmentsInput.removeAttribute('readonly');
                installmentsInput.classList.remove('bg-light');
                if (parseInt(installmentsInput.value || '0', 10) < 2) {
                    installmentsInput.value = 2;
                }
            }
            updatePreview();
        }

        function updatePreview() {
            const total = parseNumber(totalAmount.value);
            let count = parseInt(installmentsInput.value || '0', 10);
            if (!count || count < 1) count = 1;

            const approx = total / count;
            const text = approx > 0 ? formatTry(approx) : '-';

            if (prevDesktop) prevDesktop.textContent = text;
            if (prevMobile) prevMobile.textContent = text;

            if (prevTotal) prevTotal.textContent = formatTry(total);
            if (prevCount) prevCount.textContent = String(count);
            if (prevFirstDue) {
                const v = firstDue?.value;
                prevFirstDue.textContent = v ? v.split('-').reverse().join('.') : '-';
            }
            if (prevType) prevType.textContent = pesin.checked ? "Peşin" : "Aylık Taksitli";
        }

        pesin.addEventListener('change', updateInstallmentsState);
        taksit.addEventListener('change', updateInstallmentsState);
        installmentsInput.addEventListener('input', updatePreview);
        totalAmount.addEventListener('input', updatePreview);
        if (firstDue) firstDue.addEventListener('change', updatePreview);

        updateInstallmentsState();
    })();

        document.getElementById('planForm')?.addEventListener('submit', function (e) {
        const hasActive = @(hasActivePlan.ToString().ToLower());
        if (!hasActive) return;

        const ok = confirm("Bu öğrenci için aktif plan var. Devam ederseniz mevcut plan arşivlenecek ve ödenmemiş taksitler iptal edilecek. Devam edilsin mi?");
        if (!ok) e.preventDefault();
    });

</script>
