@model StudentDashboardViewModel
@{
    ViewData["Title"] = "Öğrenci Paneli";

    var overall = Model.Stats.AttendanceOverall;
    var hasMissingDocs = Model.Stats.MissingDocumentsCount > 0;
    var hasOverdueFees = Model.Stats.OverdueFeesCount > 0;
    var hasDueSoonFees = Model.Stats.DueSoonFeesCount > 0;
}

<div class="d-flex flex-wrap justify-content-between align-items-end gap-2 mb-3">
    <div>
        <h2 class="mb-1">Öğrenci Paneli</h2>
        <div class="text-muted small">Hoş geldin, @Model.UserDisplayName</div>
    </div>

    <div class="d-flex flex-wrap gap-2">
        <a asp-controller="Payments" asp-action="My" class="btn btn-sm btn-outline-primary">
            Aidatlarım
        </a>
        <a asp-controller="PaymentPlans" asp-action="My" class="btn btn-sm btn-outline-secondary">
            Aidat Planım
        </a>
        <a asp-controller="Profile" asp-action="Index" class="btn btn-sm btn-primary">
            Profilim
        </a>
    </div>
</div>

<div class="row g-3">
    <div class="col-12 col-sm-6 col-lg-3">
        <div class="card-surface p-3 h-100">
            <div class="text-muted small">Önümüzdeki 7 gün</div>
            <div class="fs-4 fw-semibold mt-1">@Model.Stats.UpcomingSessions7DaysCount</div>
            <div class="text-muted small">Ders</div>
        </div>
    </div>

    <div class="col-12 col-sm-6 col-lg-3">
        <div class="card-surface p-3 h-100">
            <div class="text-muted small">Katılım</div>
            <div class="fs-4 fw-semibold mt-1">@overall.AttendancePercent%</div>
            <div class="text-muted small">Toplam (mazeret hariç)</div>
        </div>
    </div>

    <div class="col-12 col-sm-6 col-lg-3">
        <div class="card-surface p-3 h-100">
            <div class="text-muted small">Eksik belge</div>
            <div class="fs-4 fw-semibold mt-1">@Model.Stats.MissingDocumentsCount</div>
            <div class="text-muted small">Sadece eksik varsa görünür</div>
        </div>
    </div>

    <div class="col-12 col-sm-6 col-lg-3">
        <div class="card-surface p-3 h-100">
            <div class="text-muted small">Gecikmiş aidat</div>
            <div class="fs-4 fw-semibold mt-1">@Model.Stats.OverdueFeesCount</div>
            <div class="text-muted small">Varsa aşağıda listelenir</div>
        </div>
    </div>
</div>

<div class="row g-3 mt-1">
    <div class="col-12 col-lg-7">
        <div class="card-surface p-3 h-100">
            <div class="text-muted small">Dersler</div>
            <div class="fw-semibold">Önümüzdeki 7 gün</div>

            <div class="mt-3">
                @if (Model.Stats.UpcomingSessions is null || Model.Stats.UpcomingSessions.Count == 0)
                {
                    <div class="text-muted small">Önümüzdeki 7 gün içinde planlı ders görünmüyor.</div>
                }
                else
                {
                    <div class="list-group list-group-flush dashboard-list">
                        @foreach (var s in Model.Stats.UpcomingSessions)
                        {
                            <a class="list-group-item list-group-item-action d-flex justify-content-between align-items-center"
                               asp-controller="ClassSessions"
                               asp-action="Details"
                               asp-route-id="@s.SessionId">
                                <div>
                                    <div class="fw-semibold">@s.ClassName</div>
                                    <div class="text-muted small">
                                        @s.Date.ToString("dd.MM.yyyy") · @s.StartTime.ToString("HH\\:mm") - @s.EndTime.ToString("HH\\:mm")
                                        · @s.Title
                                        @if (!string.IsNullOrWhiteSpace(s.CoachName))
                                        {
                                            <span> · @s.CoachName</span>
                                        }
                                        @if (!string.IsNullOrWhiteSpace(s.Location))
                                        {
                                            <span> · @s.Location</span>
                                        }
                                    </div>
                                </div>
                                <span class="badge-soft badge-soft-primary">Detay</span>
                            </a>
                        }
                    </div>
                }
            </div>
        </div>
    </div>

    <div class="col-12 col-lg-5">
        <div class="card-surface p-3 h-100">
            <div class="text-muted small">Katılım</div>
            <div class="fw-semibold">Toplam + Son 12 hafta</div>

            <div class="mt-3">
                <div class="text-muted small mb-2">
                    Present(+Geç): <span class="fw-semibold">@overall.PresentLikeCount</span>
                    · Absent: <span class="fw-semibold">@overall.AbsentCount</span>
                    · Mazeret: <span class="fw-semibold">@overall.ExcusedCount</span>
                </div>

                <div class="mb-3">
                    <canvas id="attendanceDonut" height="180"></canvas>
                </div>

                <div>
                    <canvas id="attendanceTrend" height="160"></canvas>
                </div>
            </div>
        </div>
    </div>
</div>

@if (hasMissingDocs)
{
    <div class="row g-3 mt-1">
        <div class="col-12">
            <div class="card-surface p-3">
                <div class="text-muted small">Eksik belgeler</div>
                <div class="fw-semibold">Lütfen tamamlayın</div>

                <div class="mt-3">
                    <div class="list-group list-group-flush dashboard-list">
                        @foreach (var d in Model.Stats.MissingDocuments)
                        {
                            <a class="list-group-item list-group-item-action d-flex justify-content-between align-items-center"
                               asp-controller="Documents"
                               asp-action="Student">
                                <div>
                                    <div class="fw-semibold">@d.Name</div>
                                    <div class="text-muted small">Eksik</div>
                                </div>
                                <span class="badge-soft badge-soft-warning">Yükle</span>
                            </a>
                        }
                    </div>

                    <div class="text-muted small mt-2">
                        Toplam eksik: <span class="fw-semibold">@Model.Stats.MissingDocumentsCount</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
}

@if (hasOverdueFees || hasDueSoonFees)
{
    <div class="row g-3 mt-1">
        @if (hasOverdueFees)
        {
            <div class="col-12 col-lg-6">
                <div class="card-surface p-3 h-100">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <div class="text-muted small">Aidat</div>
                            <div class="fw-semibold">Gecikmiş</div>
                        </div>
                        <a class="small" asp-controller="Payments" asp-action="My">Detay</a>
                    </div>

                    <div class="mt-2">
                        <div class="fw-semibold">@Model.Stats.OverdueFeesCount adet</div>
                        <div class="text-muted small">Toplam: @Model.Stats.OverdueFeesAmount.ToString("C2")</div>
                    </div>

                    @if (Model.Stats.OverdueFees.Count > 0)
                    {
                        <div class="list-group list-group-flush dashboard-list mt-3">
                            @foreach (var p in Model.Stats.OverdueFees)
                            {
                                <a class="list-group-item list-group-item-action d-flex justify-content-between align-items-center"
                                   asp-controller="Payments"
                                   asp-action="My">
                                    <div>
                                        <div class="fw-semibold">@p.Amount.ToString("C2")</div>
                                        <div class="text-muted small">Vade: @p.DueDate.ToString("yyyy-MM-dd")</div>
                                    </div>
                                    <span class="badge-soft badge-soft-danger">Gecikmiş</span>
                                </a>
                            }
                        </div>
                    }
                </div>
            </div>
        }

        @if (hasDueSoonFees)
        {
            <div class="col-12 col-lg-6">
                <div class="card-surface p-3 h-100">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <div class="text-muted small">Aidat</div>
                            <div class="fw-semibold">3 gün içinde vadesi dolacak</div>
                        </div>
                        <a class="small" asp-controller="Payments" asp-action="My">Detay</a>
                    </div>

                    <div class="mt-2">
                        <div class="fw-semibold">@Model.Stats.DueSoonFeesCount adet</div>
                        <div class="text-muted small">Toplam: @Model.Stats.DueSoonFeesAmount.ToString("C2")</div>
                    </div>

                    @if (Model.Stats.DueSoonFees.Count > 0)
                    {
                        <div class="list-group list-group-flush dashboard-list mt-3">
                            @foreach (var p in Model.Stats.DueSoonFees)
                            {
                                <a class="list-group-item list-group-item-action d-flex justify-content-between align-items-center"
                                   asp-controller="Payments"
                                   asp-action="My">
                                    <div>
                                        <div class="fw-semibold">@p.Amount.ToString("C2")</div>
                                        <div class="text-muted small">Vade: @p.DueDate.ToString("yyyy-MM-dd")</div>
                                    </div>
                                    <span class="badge-soft badge-soft-warning">Yaklaşıyor</span>
                                </a>
                            }
                        </div>
                    }
                </div>
            </div>
        }
    </div>
}

<div class="row g-3 mt-1">
    <div class="col-12">
        <div class="card-surface p-3">
            <div class="text-muted small">Son duyurular</div>
            <div class="fw-semibold">Top 5</div>

            <div class="mt-3">
                @if (Model.Stats.RecentAnnouncements is null || Model.Stats.RecentAnnouncements.Count == 0)
                {
                    <div class="text-muted small">Yayında duyuru yok.</div>
                }
                else
                {
                    <div class="list-group list-group-flush dashboard-list">
                        @foreach (var a in Model.Stats.RecentAnnouncements)
                        {
                            <a class="list-group-item list-group-item-action d-flex justify-content-between align-items-center"
                               asp-controller="Announcements"
                               asp-action="Details"
                               asp-route-id="@a.Id">
                                <div>
                                    <div class="fw-semibold">@a.Title</div>
                                    <div class="text-muted small">@a.PublishDate.ToString("yyyy-MM-dd")</div>
                                </div>
                                <span class="badge-soft badge-soft-muted">Detay</span>
                            </a>
                        }
                    </div>
                }
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        (function () {
            const presentLike = @overall.PresentLikeCount;
            const absent = @overall.AbsentCount;

            const donutEl = document.getElementById('attendanceDonut');
            if (donutEl) {
                new Chart(donutEl, {
                    type: 'doughnut',
                    data: {
                        labels: ['Katıldı (+Geç)', 'Kaçırdı'],
                        datasets: [{
                            data: [presentLike, absent]
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            legend: { display: true }
                        }
                    }
                });
            }

            const labels = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(Model.Stats.AttendanceWeeklyTrend.Select(x => x.Label)));
            const percents = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(Model.Stats.AttendanceWeeklyTrend.Select(x => x.AttendancePercent)));

            const trendEl = document.getElementById('attendanceTrend');
            if (trendEl) {
                new Chart(trendEl, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Katılım %',
                            data: percents,
                            tension: 0.25
                        }]
                    },
                    options: {
                        responsive: true,
                        scales: {
                            y: { beginAtZero: true, max: 100 }
                        },
                        plugins: {
                            legend: { display: false }
                        }
                    }
                });
            }
        })();
    </script>
}
