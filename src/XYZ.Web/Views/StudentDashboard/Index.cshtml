@model StudentDashboardViewModel
@{
    ViewData["Title"] = "Öğrenci Paneli";

    var overall = Model.Stats.AttendanceOverall;

    var hasMissingDocs = Model.Stats.MissingDocumentsCount > 0;
    var hasOverdueFees = Model.Stats.OverdueFeesCount > 0;
    var hasDueSoonFees = Model.Stats.DueSoonFeesCount > 0;

    var hasReminders = hasMissingDocs || hasOverdueFees || hasDueSoonFees;

    var trend2w = (Model.Stats.AttendanceWeeklyTrend ?? new List<XYZ.Application.Features.Dashboard.Queries.GetStudentDashboard.AttendanceWeeklyTrendItemDto>())
        .TakeLast(2)
        .ToList();

    var donutPresentLike = overall.PresentLikeCount;
    var donutAbsent = overall.AbsentCount;
}

<div class="d-flex flex-wrap justify-content-between align-items-end gap-2 mb-3">
    <div>
        <h2 class="mb-1">Öğrenci Paneli</h2>
        <div class="text-muted small">Hoş geldin, @Model.UserDisplayName</div>
    </div>

    <div class="d-flex flex-wrap gap-2">
        <a asp-controller="Calendar" asp-action="Index" class="btn btn-sm btn-primary">
            Takvim
        </a>
        <a asp-controller="Profile" asp-action="Index" class="btn btn-sm btn-primary">
            Profilim
        </a>
    </div>
</div>

<!-- TOP STATS -->
<div class="row g-3">
    <div class="col-12 col-sm-6 col-lg-3">
        <div class="card-surface p-3 h-100">
            <div class="text-muted small">Önümüzdeki 7 gün</div>
            <div class="fs-4 fw-semibold mt-1">@Model.Stats.UpcomingSessions7DaysCount</div>
            <div class="text-muted small">Ders</div>
        </div>
    </div>

    <div class="col-12 col-sm-6 col-lg-3">
        <div class="card-surface p-3 h-100">
            <div class="d-flex justify-content-between align-items-start">
                <div>
                    <div class="text-muted small">Katılım</div>
                    <div class="fs-4 fw-semibold mt-1">@overall.AttendancePercent%</div>
                    <div class="text-muted small">Genel durum</div>
                </div>
                <div style="width:86px;">
                    <canvas id="attendanceDonutSmall" height="86"></canvas>
                </div>
            </div>
        </div>
    </div>

    <div class="col-12 col-sm-6 col-lg-3">
        <div class="card-surface p-3 h-100">
            <div class="text-muted small">Aidatlar</div>
            @if (hasOverdueFees)
            {
                <div class="fs-4 fw-semibold mt-1">@Model.Stats.OverdueFeesCount</div>
                <div class="text-muted small">Gecikmiş aidat</div>
            }
            else
            {
                <div class="fs-6 fw-semibold mt-2">Her şey yolunda ✅</div>
                <div class="text-muted small">Gecikmiş aidat yok</div>
            }
        </div>
    </div>

    <div class="col-12 col-sm-6 col-lg-3">
        <div class="card-surface p-3 h-100">
            <div class="text-muted small">Duyurular</div>
            <div class="fs-4 fw-semibold mt-1">@((Model.Stats.RecentAnnouncements?.Count) ?? 0)</div>
            <div class="text-muted small">Son duyurular</div>
        </div>
    </div>
</div>

<!-- REMINDERS + ANNOUNCEMENTS -->
<div class="row g-3 mt-1">
    @if (hasReminders)
    {
        <div class="col-12 col-lg-6">
            <div class="card-surface p-3 h-100">
                <div class="text-muted small">Hatırlatmalar</div>
                <div class="fw-semibold">Önemli konular</div>

                <div class="mt-3">
                    <div class="list-group list-group-flush dashboard-list">

                        @if (hasMissingDocs)
                        {
                            <a class="list-group-item list-group-item-action d-flex justify-content-between align-items-center"
                               asp-controller="Documents"
                               asp-action="My">
                                <div>
                                    <div class="fw-semibold">Eksik belgeler</div>
                                    <div class="text-muted small">Toplam eksik: @Model.Stats.MissingDocumentsCount</div>
                                </div>
                                <span class="badge-soft badge-soft-warning">Yükle</span>
                            </a>
                        }

                        @if (hasOverdueFees)
                        {
                            <a class="list-group-item list-group-item-action d-flex justify-content-between align-items-center"
                               asp-controller="Payments"
                               asp-action="My">
                                <div>
                                    <div class="fw-semibold">Gecikmiş aidat</div>
                                    <div class="text-muted small">
                                        @Model.Stats.OverdueFeesCount adet · Toplam @Model.Stats.OverdueFeesAmount.ToString("C2")
                                    </div>
                                </div>
                                <span class="badge-soft badge-soft-danger">Detay</span>
                            </a>
                        }

                        @if (hasDueSoonFees)
                        {
                            <a class="list-group-item list-group-item-action d-flex justify-content-between align-items-center"
                               asp-controller="Payments"
                               asp-action="My">
                                <div>
                                    <div class="fw-semibold">3 gün içinde vadesi dolacak aidat</div>
                                    <div class="text-muted small">
                                        @Model.Stats.DueSoonFeesCount adet · Toplam @Model.Stats.DueSoonFeesAmount.ToString("C2")
                                    </div>
                                </div>
                                <span class="badge-soft badge-soft-warning">Detay</span>
                            </a>
                        }

                    </div>
                </div>
            </div>
        </div>
    }

    <div class="col-12 col-lg-6">
        <div class="card-surface p-3 h-100">
            <div class="text-muted small">Son duyurular</div>
            <div class="fw-semibold">Top 5</div>

            <div class="mt-3">
                @if (Model.Stats.RecentAnnouncements is null || Model.Stats.RecentAnnouncements.Count == 0)
                {
                    <div class="text-muted small">Yayında duyuru yok.</div>
                }
                else
                {
                    <div class="list-group list-group-flush dashboard-list">
                        @foreach (var a in Model.Stats.RecentAnnouncements)
                        {
                            <a class="list-group-item list-group-item-action d-flex justify-content-between align-items-center"
                               asp-controller="Announcements"
                               asp-action="Details"
                               asp-route-id="@a.Id">
                                <div>
                                    <div class="fw-semibold">@a.Title</div>
                                    <div class="text-muted small">@a.PublishDate.ToString("yyyy-MM-dd")</div>
                                </div>
                                <span class="badge-soft badge-soft-muted">Detay</span>
                            </a>
                        }
                    </div>
                }
            </div>
        </div>
    </div>
</div>

<div class="row g-3 mt-1">
    <div class="col-12 col-lg-8">
        <div class="card-surface p-3">
            <div class="d-flex justify-content-between align-items-end">
                <div>
                    <div class="text-muted small">Dersler</div>
                    <div class="fw-semibold">Önümüzdeki 7 gün</div>
                </div>

                <a class="small" asp-controller="ClassSessions" asp-action="My">
                    Ders programına git
                </a>
            </div>

            <div class="mt-3">
                @if (Model.Stats.UpcomingSessions is null || Model.Stats.UpcomingSessions.Count == 0)
                {
                    <div class="text-muted small">Önümüzdeki 7 gün içinde planlı ders görünmüyor.</div>
                }
                else
                {
                    <div class="list-group list-group-flush dashboard-list">
                        @foreach (var s in Model.Stats.UpcomingSessions)
                        {
                            <a class="list-group-item list-group-item-action d-flex justify-content-between align-items-center"
                               asp-controller="ClassSessions"
                               asp-action="Details"
                               asp-route-id="@s.SessionId">
                                <div>
                                    <div class="fw-semibold">@s.ClassName</div>
                                    <div class="text-muted small">
                                        @s.Date.ToString("dd.MM.yyyy") · @s.StartTime.ToString("HH\\:mm") - @s.EndTime.ToString("HH\\:mm")
                                        · @s.Title
                                        @if (!string.IsNullOrWhiteSpace(s.CoachName))
                                        {
                                            <span> · @s.CoachName</span>
                                        }
                                        @if (!string.IsNullOrWhiteSpace(s.Location))
                                        {
                                            <span> · @s.Location</span>
                                        }
                                    </div>
                                </div>
                                <span class="badge-soft badge-soft-primary">Detay</span>
                            </a>
                        }
                    </div>
                }
            </div>
        </div>
    </div>

    <div class="col-12 col-lg-4">
        <div class="card-surface p-3">
            <div class="text-muted small">Katılım</div>
            <div class="fw-semibold">Son 2 hafta</div>

            <div class="mt-2 d-flex flex-wrap gap-2 text-muted small">
                <span>Katıldı: <span class="fw-semibold">@overall.PresentLikeCount</span></span>
                <span>·</span>
                <span>Kaçırdı: <span class="fw-semibold">@overall.AbsentCount</span></span>
                <span>·</span>
                <span>Mazeret: <span class="fw-semibold">@overall.ExcusedCount</span></span>
            </div>

            <div class="mt-3">
                <canvas id="attendance2w" height="140"></canvas>
            </div>

            <div class="mt-2 text-muted small">
                Genel katılım: <span class="fw-semibold">@overall.AttendancePercent%</span>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        (function () {
            const presentLike = @donutPresentLike;
            const absent = @donutAbsent;

            const donutEl = document.getElementById('attendanceDonutSmall');
            if (donutEl) {
                new Chart(donutEl, {
                    type: 'doughnut',
                    data: {
                        labels: ['Katıldı (+Geç)', 'Kaçırdı'],
                        datasets: [{
                            data: [presentLike, absent]
                        }]
                    },
                    options: {
                        responsive: true,
                        cutout: '70%',
                        plugins: {
                            legend: { display: false },
                            tooltip: { enabled: true }
                        }
                    }
                });
            }

            const labels = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(trend2w.Select(x => x.Label)));
            const percents = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(trend2w.Select(x => x.AttendancePercent)));

            const el = document.getElementById('attendance2w');
            if (el) {
                new Chart(el, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Katılım %',
                            data: percents
                        }]
                    },
                    options: {
                        responsive: true,
                        scales: {
                            y: { beginAtZero: true, max: 100 }
                        },
                        plugins: {
                            legend: { display: false },
                            tooltip: { enabled: true }
                        }
                    }
                });
            }
        })();
    </script>
}
