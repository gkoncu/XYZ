@model StudentDetailDto
@inject IConfiguration Config
@{
    ViewData["Title"] = "Öğrenci Detayı";

    string GenderTr(string? value) => value switch
    {
        "Male" => "Erkek",
        "Female" => "Kadın",
        "PreferNotToSay" => "Belirtilmedi",
        _ => string.IsNullOrWhiteSpace(value) ? "-" : value
    };

    string BloodTypeTr(string? value) => value switch
    {
        "Unknown" => "Bilinmiyor",
        "A_Positive" => "A+",
        "A_Negative" => "A-",
        "B_Positive" => "B+",
        "B_Negative" => "B-",
        "AB_Positive" => "AB+",
        "AB_Negative" => "AB-",
        "O_Positive" => "0+",
        "O_Negative" => "0-",
        _ => string.IsNullOrWhiteSpace(value) ? "-" : value
    };

    string BuildInitials(string name)
    {
        if (string.IsNullOrWhiteSpace(name)) return "?";
        var parts = name.Split(' ', StringSplitOptions.RemoveEmptyEntries | StringSplitOptions.TrimEntries)
                        .Take(2)
                        .ToArray();
        if (parts.Length == 0) return "?";
        if (parts.Length == 1) return parts[0].Substring(0, 1).ToUpperInvariant();
        return (parts[0].Substring(0, 1) + parts[1].Substring(0, 1)).ToUpperInvariant();
    }

    string? NormalizeAssetUrl(string? raw)
    {
        if (string.IsNullOrWhiteSpace(raw)) return null;
        if (raw.StartsWith("http://", StringComparison.OrdinalIgnoreCase) || raw.StartsWith("https://", StringComparison.OrdinalIgnoreCase))
            return raw;

        var baseUrl = (Config["Api:BaseUrl"] ?? string.Empty);
        if (!Uri.TryCreate(baseUrl, UriKind.Absolute, out var apiUri))
            return raw;

        var origin = apiUri.GetLeftPart(UriPartial.Authority);
        if (!raw.StartsWith("/")) raw = "/" + raw;

        return $"{origin}{raw}?v={DateTime.UtcNow.Ticks}";
    }

    var initials = BuildInitials(Model.FullName ?? "");
    var profilePictureUrl = NormalizeAssetUrl(Model.ProfilePictureUrl);
    var hasPhoto = !string.IsNullOrWhiteSpace(profilePictureUrl);

    var canManageStudent = User.IsInRole("Admin") || User.IsInRole("Coach") || User.IsInRole("SuperAdmin");
    var isAdmin = User.IsInRole("Admin") || User.IsInRole("SuperAdmin");
}

<section class="mb-3 d-flex flex-wrap justify-content-between align-items-center gap-2">
    <a asp-action="Index" class="text-muted small text-decoration-none">&larr; Öğrenci listesine dön</a>
</section>

@if (canManageStudent)
{
    <section class="card-surface mb-3 d-md-none">
        <div class="card-body">
            <div class="fw-semibold mb-2">Hızlı İşlemler</div>

            <div class="d-grid gap-2">
                <a asp-controller="Attendance" asp-action="List" asp-route-studentId="@Model.Id" class="btn btn-outline-primary">Yoklama Geçmişi</a>
                <a asp-controller="Documents" asp-action="Student" asp-route-studentId="@Model.Id" class="btn btn-outline-primary">Belgeler</a>
                <a asp-controller="Payments" asp-action="Index" asp-route-studentId="@Model.Id" class="btn btn-outline-primary">Aidatlar</a>
                <a asp-controller="PaymentPlans" asp-action="Student" asp-route-studentId="@Model.Id" class="btn btn-outline-primary">Aidat Planı</a>
                <a asp-controller="ProgressRecords" asp-action="Student" asp-route-studentId="@Model.Id" class="btn btn-outline-primary">Gelişim Kayıtları</a>
            </div>

            @if (isAdmin)
            {
                <hr class="my-3" />
                <div class="d-grid gap-2">
                    <a asp-action="Edit" asp-route-id="@Model.Id" class="btn btn-outline-secondary">Düzenle</a>

                    <form asp-action="Delete" asp-route-id="@Model.Id" method="post">
                        @Html.AntiForgeryToken()
                        <button type="submit" class="btn btn-outline-danger w-100"
                                onclick="return confirm('Bu öğrenciyi silmek istediğinize emin misiniz?');">
                            Sil
                        </button>
                    </form>
                </div>
            }
        </div>
    </section>
}

<section class="detail-grid">
    <div class="card-surface">
        <h2 class="h5 mb-3">Öğrenci Bilgileri</h2>

        <div class="d-flex align-items-start gap-3 mb-3">
            <div class="rounded-circle border d-inline-flex align-items-center justify-content-center flex-shrink-0"
                 style="width:72px;height:72px;overflow:hidden;background:rgba(0,0,0,.04);">
                @if (hasPhoto)
                {
                    <img src="@profilePictureUrl" alt="Profil Fotoğrafı" style="width:100%;height:100%;object-fit:cover;" />
                }
                else
                {
                    <span class="fw-semibold" style="font-size:22px; letter-spacing:.5px;">@initials</span>
                }
            </div>

            <div class="flex-grow-1">
                <div class="fw-semibold fs-5">@Model.FullName</div>
                <div class="small text-muted">@Model.Email</div>
                @if (!string.IsNullOrWhiteSpace(Model.PhoneNumber))
                {
                    <div class="small text-muted">@Model.PhoneNumber</div>
                }
            </div>
        </div>

        <div class="row g-3 mb-3">
            <div class="col-md-4">
                <div class="small text-muted">Sınıf</div>
                <div>@(Model.ClassName ?? "Henüz atanmadı")</div>
            </div>
            <div class="col-md-4">
                <div class="small text-muted">Şube</div>
                <div>@(Model.BranchName ?? "-")</div>
            </div>
            <div class="col-md-4">
                <div class="small text-muted">Durum</div>
                @if (Model.IsActive)
                {
                    <span class="badge-soft badge-soft-success">Aktif</span>
                }
                else
                {
                    <span class="badge-soft badge-soft-muted">Pasif</span>
                }
            </div>
        </div>

        <div class="row g-3 mb-3">
            <div class="col-md-4">
                <div class="small text-muted">Cinsiyet</div>
                <div>@GenderTr(Model.Gender)</div>
            </div>
            <div class="col-md-4">
                <div class="small text-muted">Kan Grubu</div>
                <div>@BloodTypeTr(Model.BloodType)</div>
            </div>
            <div class="col-md-4">
                <div class="small text-muted">Doğum Tarihi</div>
                <div>@Model.BirthDate.ToString("dd.MM.yyyy")</div>
            </div>
        </div>

        <div class="row g-3">
            <div class="col-md-6">
                <h3 class="h6 mb-2">Veli 1</h3>
                <div class="small text-muted">Ad Soyad</div>
                <div>@($"{Model.Parent1FirstName} {Model.Parent1LastName}".Trim())</div>
                <div class="small text-muted mt-2">E-posta</div>
                <div>@Model.Parent1Email</div>
                <div class="small text-muted mt-2">Telefon</div>
                <div>@Model.Parent1PhoneNumber</div>
            </div>
            <div class="col-md-6">
                <h3 class="h6 mb-2">Veli 2</h3>
                <div class="small text-muted">Ad Soyad</div>
                <div>@($"{Model.Parent2FirstName} {Model.Parent2LastName}".Trim())</div>
                <div class="small text-muted mt-2">E-posta</div>
                <div>@Model.Parent2Email</div>
                <div class="small text-muted mt-2">Telefon</div>
                <div>@Model.Parent2PhoneNumber</div>
            </div>
        </div>

        @if (!string.IsNullOrWhiteSpace(Model.MedicalInformation) || !string.IsNullOrWhiteSpace(Model.Notes))
        {
            <hr class="my-4" />
            <div class="row g-3">
                @if (!string.IsNullOrWhiteSpace(Model.MedicalInformation))
                {
                    <div class="col-md-6">
                        <h3 class="h6 mb-2">Sağlık Bilgileri</h3>
                        <p class="small text-muted mb-0">@Model.MedicalInformation</p>
                    </div>
                }
                @if (!string.IsNullOrWhiteSpace(Model.Notes))
                {
                    <div class="col-md-6">
                        <h3 class="h6 mb-2">Notlar</h3>
                        <p class="small text-muted mb-0">@Model.Notes</p>
                    </div>
                }
            </div>
        }
    </div>

    <div class="vstack gap-3">
        @if (canManageStudent)
        {
            <div class="card-surface d-none d-md-block">
                <h2 class="h6 mb-3">Hızlı İşlemler</h2>

                <div class="d-grid gap-2">
                    <a asp-controller="Attendance" asp-action="List" asp-route-studentId="@Model.Id" class="btn btn-outline-primary">Yoklama Geçmişi</a>
                    <a asp-controller="Documents" asp-action="Student" asp-route-studentId="@Model.Id" class="btn btn-outline-primary">Belgeler</a>
                    <a asp-controller="Payments" asp-action="Index" asp-route-studentId="@Model.Id" class="btn btn-outline-primary">Aidatlar</a>

                    <div class="d-flex gap-2">
                        <a asp-controller="Payments" asp-action="Index" asp-route-studentId="@Model.Id" asp-route-status="Pending" class="btn btn-outline-secondary w-100">Beklemede</a>
                        <a asp-controller="Payments" asp-action="Index" asp-route-studentId="@Model.Id" asp-route-status="Overdue" class="btn btn-outline-secondary w-100">Gecikmiş</a>
                    </div>

                    <a asp-controller="PaymentPlans" asp-action="Student" asp-route-studentId="@Model.Id" class="btn btn-outline-primary">Aidat Planı</a>
                    <a asp-controller="ProgressRecords" asp-action="Student" asp-route-studentId="@Model.Id" class="btn btn-outline-primary">Gelişim Kayıtları</a>
                </div>

                @if (isAdmin)
                {
                    <hr class="my-3" />
                    <div class="d-grid gap-2">
                        <a asp-action="Edit" asp-route-id="@Model.Id" class="btn btn-outline-secondary">Düzenle</a>

                        <form asp-action="Delete" asp-route-id="@Model.Id" method="post">
                            @Html.AntiForgeryToken()
                            <button type="submit" class="btn btn-outline-danger w-100"
                                    onclick="return confirm('Bu öğrenciyi silmek istediğinize emin misiniz?');">
                                Sil
                            </button>
                        </form>
                    </div>
                }
            </div>
        }

        <div class="card-surface">
            <h2 class="h6 mb-3">Özet</h2>
            <dl class="row small mb-0">
                <dt class="col-5 text-muted">Kayıt Tarihi</dt>
                <dd class="col-7">@Model.CreatedAt.ToString("dd.MM.yyyy HH:mm")</dd>

                @if (Model.UpdatedAt.HasValue)
                {
                    <dt class="col-5 text-muted">Son Güncelleme</dt>
                    <dd class="col-7">@Model.UpdatedAt.Value.ToString("dd.MM.yyyy HH:mm")</dd>
                }
            </dl>
        </div>
    </div>
</section>

@if (isAdmin)
{
    <div class="d-md-none position-sticky bottom-0 start-0 end-0 bg-white border-top mt-4" style="z-index: 1020;">
        <div class="container-fluid py-2">
            <div class="d-flex gap-2">
                <a asp-action="Edit" asp-route-id="@Model.Id" class="btn btn-primary flex-fill">Düzenle</a>

                <form asp-action="Delete" asp-route-id="@Model.Id" method="post" class="flex-fill">
                    @Html.AntiForgeryToken()
                    <button type="submit" class="btn btn-outline-danger w-100"
                            onclick="return confirm('Bu öğrenciyi silmek istediğinize emin misiniz?');">
                        Sil
                    </button>
                </form>
            </div>
        </div>
    </div>
}
