@using XYZ.Domain.Enums
@model PaginationResult<XYZ.Application.Features.Payments.Queries.GetPayments.PaymentListItemDto>
@{
    var isMyPayments = (ViewBag.IsMyPayments as bool?) ?? false;
    int? studentId = ViewBag.StudentId as int?;

    DateOnly? fromDueDate = ViewBag.FromDueDate as DateOnly?;
    DateOnly? toDueDate = ViewBag.ToDueDate as DateOnly?;
    PaymentStatus? status = ViewBag.Status as PaymentStatus?;

    ViewData["Title"] ??= isMyPayments
        ? "Ödemelerim"
        : (studentId.HasValue ? "Öğrenci Ödemeleri" : "Ödemeler");

    string actionName = isMyPayments ? "My" : "Index";
}

<section class="mb-3">
    <div class="d-flex justify-content-between align-items-center mb-2">
        <div>
            <h2 class="h4 mb-1">
                @if (isMyPayments)
                {
                    @:Ödemelerim
                }
                else if (studentId.HasValue)
                {
                    @:Öğrenci Ödemeleri
                }
                else
                {
                    @:Ödemeler
                }
            </h2>
            <p class="text-muted small mb-0">
                Ödenmemiş (bekleyen / gecikmiş) ödemeler listenin en üstünde gösterilir. Varsayılan filtre: son 30 gün / gelecek 30 gün (vade tarihine göre).
            </p>
        </div>

        @if (!isMyPayments)
        {
            <div>
                <a asp-controller="Students"
                   asp-action="Index"
                   class="btn btn-sm btn-outline-secondary">
                    Öğrenci listesi
                </a>
            </div>
        }
    </div>

    <form asp-action="@actionName" method="get" class="row g-2 align-items-end">
        @if (studentId.HasValue)
        {
            <input type="hidden" name="studentId" value="@studentId.Value" />
        }

        <div class="col-12 col-md-3">
            <label class="form-label small mb-1">Vade Başlangıç</label>
            <input type="date" class="form-control form-control-sm" name="fromDueDate"
                   value="@(fromDueDate.HasValue? fromDueDate.Value.ToString("yyyy-MM-dd") : string.Empty)" />
        </div>

        <div class="col-12 col-md-3">
            <label class="form-label small mb-1">Vade Bitiş</label>
            <input type="date" class="form-control form-control-sm" name="toDueDate"
                   value="@(toDueDate.HasValue? toDueDate.Value.ToString("yyyy-MM-dd") : string.Empty)" />
        </div>

        <div class="col-12 col-md-3">
            <label class="form-label small mb-1">Durum</label>
            <select class="form-select form-select-sm" name="status">
                <option value="" selected="@(status is null ? "selected" : null)">Hepsi</option>
                <option value="@PaymentStatus.Pending" selected="@(status == PaymentStatus.Pending ? "selected" : null)">Beklemede</option>
                <option value="@PaymentStatus.Overdue" selected="@(status == PaymentStatus.Overdue ? "selected" : null)">Gecikmiş</option>
                <option value="@PaymentStatus.Paid" selected="@(status == PaymentStatus.Paid ? "selected" : null)">Ödendi</option>
                <option value="@PaymentStatus.Cancelled" selected="@(status == PaymentStatus.Cancelled ? "selected" : null)">İptal</option>
            </select>
        </div>

        <div class="col-12 col-md-3 d-flex gap-2">
            <button type="submit" class="btn btn-sm btn-primary w-100">Filtrele</button>
            <a class="btn btn-sm btn-outline-secondary w-100"
               asp-action="@actionName"
               asp-route-studentId="@studentId">
                Sıfırla
            </a>
        </div>
    </form>
</section>

<section class="card-surface">
    <div class="table-responsive">
        <table class="table table-sm align-middle mb-0">
            <thead class="table-light">
                <tr>
                    <th>Öğrenci</th>
                    <th class="text-end">Tutar</th>
                    <th class="text-end">İndirim</th>
                    <th class="text-end">Net</th>
                    <th>Durum</th>
                    <th>Vade</th>
                    <th class="text-end"></th>
                </tr>
            </thead>
            <tbody>
                @if (Model.Items.Count == 0)
                {
                    <tr>
                        <td colspan="8" class="text-center text-muted py-3">
                            Kayıt bulunamadı.
                        </td>
                    </tr>
                }
                else
                {
                    foreach (var item in Model.Items)
                    {
                        var netAmount = item.Amount - (item.DiscountAmount ?? 0m);
                        string statusClass = item.Status switch
                        {
                            PaymentStatus.Pending => "badge bg-warning text-dark",
                            PaymentStatus.Overdue => "badge bg-danger",
                            PaymentStatus.Paid => "badge bg-success",
                            PaymentStatus.Cancelled => "badge bg-secondary",
                            _ => "badge bg-secondary"
                        };

                        <tr>
                            <td>@item.StudentFullName</td>
                            <td class="text-end">@item.Amount.ToString("C2")</td>
                            <td class="text-end">@(item.DiscountAmount.HasValue? item.DiscountAmount.Value.ToString("C2") : "-")</td>
                            <td class="text-end fw-semibold">@netAmount.ToString("C2")</td>
                            <td>
                                <span class="@statusClass">@item.Status.ToDisplayName()</span>
                            </td>
                            <td>@item.DueDate.ToString("dd.MM.yyyy")</td>
                            <td class="text-end">
                                <a asp-action="Details"
                                   asp-route-id="@item.Id"
                                   class="btn btn-sm btn-outline-secondary">
                                    Detay
                                </a>
                            </td>
                        </tr>
                    }
                }
            </tbody>
        </table>
    </div>
</section>
