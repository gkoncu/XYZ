@model PaginationResult<PaymentListItemDto>
@{
    var isMyPayments = (ViewBag.IsMyPayments as bool?) ?? false;
    int? studentId = ViewBag.StudentId as int?;
    ViewData["Title"] ??= isMyPayments
        ? "Ödemelerim"
        : (studentId.HasValue ? "Öğrenci Ödemeleri" : "Ödemeler");
}

<section class="mb-3">
    <div class="d-flex justify-content-between align-items-center mb-2">
        <div>
            <h2 class="h4 mb-1">
                @if (isMyPayments)
                {
                    @:Ödemelerim
                }
                else if (studentId.HasValue)
                {
                    @:Öğrenci Ödemeleri
                }
                else
                {
                    @:Ödemeler
                }
            </h2>
            <p class="text-muted small mb-0">
                Ödenmemiş (bekleyen / gecikmiş) ödemeler listenin en üstünde, vade tarihine göre sıralı gösterilir.
            </p>
        </div>

        @if (!isMyPayments)
        {
            <div>
                <a asp-controller="Students"
                   asp-action="Index"
                   class="btn btn-sm btn-outline-secondary">
                    Öğrenci listesi
                </a>
            </div>
        }
    </div>
</section>

<section class="card-surface">
    <div class="table-responsive">
        <table class="table table-sm align-middle mb-0">
            <thead class="table-light">
                <tr>
                    <th>Öğrenci</th>
                    <th class="text-end">Tutar</th>
                    <th class="text-end">İndirim</th>
                    <th class="text-end">Net</th>
                    <th>Durum</th>

                    <th>Vade</th>

                    <th>Oluşturma</th>
                    <th class="text-end"></th>
                </tr>
            </thead>
            <tbody>
                @if (Model.Items.Count == 0)
                {
                    <tr>
                        <td colspan="8" class="text-center text-muted py-3">
                            Kayıt bulunamadı.
                        </td>
                    </tr>
                }
                else
                {
                    foreach (var item in Model.Items)
                    {
                        var netAmount = item.Amount - (item.DiscountAmount ?? 0m);
                        string statusClass = item.Status switch
                        {
                            PaymentStatus.Pending => "badge bg-warning text-dark",
                            PaymentStatus.Overdue => "badge bg-danger",
                            PaymentStatus.Paid => "badge bg-success",
                            PaymentStatus.Cancelled => "badge bg-secondary",
                            _ => "badge bg-secondary"
                        };

                        <tr>
                            <td>@item.StudentFullName</td>
                            <td class="text-end">@item.Amount.ToString("C2")</td>
                            <td class="text-end">
                                @(item.DiscountAmount.HasValue? item.DiscountAmount.Value.ToString("C2") : "-")
                            </td>
                            <td class="text-end fw-semibold">@netAmount.ToString("C2")</td>
                            <td>
                                <span class="@statusClass">@item.Status.ToDisplayName()</span>
                            </td>

                            <td>
                                @item.DueDate.ToString("dd.MM.yyyy")
                            </td>

                            <td>@item.CreatedAt.ToString("dd.MM.yyyy HH:mm")</td>
                            <td class="text-end">
                                <a asp-action="Details"
                                   asp-route-id="@item.Id"
                                   class="btn btn-sm btn-outline-secondary">
                                    Detay
                                </a>
                            </td>
                        </tr>
                    }
                }
            </tbody>
        </table>
    </div>

    @if (Model.TotalCount > Model.PageSize)
    {
        <div class="mt-3 d-flex justify-content-between align-items-center">
            <div class="small text-muted">
                Toplam @Model.TotalCount kayıt
            </div>
            <nav>
                <ul class="pagination pagination-sm mb-0">
                    @{
                        var prevDisabled = Model.PageNumber <= 1 ? "disabled" : "";
                        var nextDisabled = (Model.PageNumber * Model.PageSize) >= Model.TotalCount ? "disabled" : "";
                    }

                    <li class="page-item @prevDisabled">
                        <a class="page-link"
                           asp-action="@(isMyPayments ? "My" : "Index")"
                           asp-route-pageNumber="@(Model.PageNumber - 1)"
                           asp-route-studentId="@(studentId)">
                            Önceki
                        </a>
                    </li>

                    <li class="page-item active">
                        <span class="page-link">@Model.PageNumber</span>
                    </li>

                    <li class="page-item @nextDisabled">
                        <a class="page-link"
                           asp-action="@(isMyPayments ? "My" : "Index")"
                           asp-route-pageNumber="@(Model.PageNumber + 1)"
                           asp-route-studentId="@(studentId)">
                            Sonraki
                        </a>
                    </li>
                </ul>
            </nav>
        </div>
    }
</section>
