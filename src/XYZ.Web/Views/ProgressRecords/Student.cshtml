@model XYZ.Web.Models.ProgressRecords.StudentProgressRecordsViewModel

@{
    ViewData["Title"] = "Gelişim Kayıtları";

    var canWrite = Model.CanWrite;
    var isStudent = User.IsInRole("Student");
    var isAdmin = User.IsInRole("Admin") || User.IsInRole("SuperAdmin") || User.IsInRole("Coach");

    string backController = isStudent ? "StudentDashboard" : "Students";
    string backAction = isStudent ? "Index" : "Details";

    string SafeDate(DateTime? dt) => dt.HasValue ? dt.Value.ToString("yyyy-MM-dd") : "";
    string TrDate(DateTime dt) => dt.ToString("dd.MM.yyyy");

    string Short(string? s, int max = 60)
    {
        if (string.IsNullOrWhiteSpace(s)) return "-";
        s = s.Trim();
        return s.Length > max ? s.Substring(0, max) + "..." : s;
    }
}

<section class="mb-3 d-flex flex-wrap justify-content-between align-items-center gap-2">
    <a class="text-muted small text-decoration-none"
       asp-controller="@backController"
       asp-action="@backAction"
       asp-route-id="@(isStudent ? null : Model.StudentId)">
        &larr; Geri dön
    </a>

    <div class="d-flex flex-wrap gap-2">
        @if (!isStudent)
        {
            <a class="btn btn-sm btn-outline-secondary"
               asp-controller="Students"
               asp-action="Details"
               asp-route-id="@Model.StudentId">
                Öğrenci Detayı
            </a>
        }

        <a class="btn btn-sm btn-outline-primary"
           asp-controller="PaymentPlans"
           asp-action="@(isStudent ? "My" : "Student")"
           asp-route-studentId="@(isStudent ? null : Model.StudentId)">
            Aidat Planı
        </a>

        <a class="btn btn-sm btn-outline-primary"
           asp-controller="Payments"
           asp-action="@(isStudent ? "My" : "Index")"
           asp-route-studentId="@(isStudent ? null : Model.StudentId)">
            Aidatlar
        </a>

        <a class="btn btn-sm btn-outline-primary"
           asp-controller="Documents"
           asp-action="Student"
           asp-route-studentId="@Model.StudentId">
            Belgeler
        </a>

        @if (canWrite)
        {
            <a class="btn btn-sm btn-primary"
               asp-action="Create"
               asp-route-studentId="@Model.StudentId">
                + Yeni Kayıt
            </a>
        }
    </div>
</section>

<section class="mb-3">
    <div>
        <h2 class="h4 mb-1">Gelişim Kayıtları</h2>
        <div class="text-muted small">
            Öğrenci: <span class="fw-semibold">@Model.StudentFullName</span> · ID: @Model.StudentId
        </div>
    </div>
</section>

@if (TempData["SuccessMessage"] is string ok && !string.IsNullOrWhiteSpace(ok))
{
    <div class="alert alert-success py-2 small">@ok</div>
}
@if (TempData["ErrorMessage"] is string err && !string.IsNullOrWhiteSpace(err))
{
    <div class="alert alert-danger py-2 small">@err</div>
}

<section class="card-surface mb-3">
    <div class="d-flex justify-content-between align-items-center gap-2 mb-2">
        <div class="fw-semibold">Filtre</div>
        <div class="small text-muted d-none d-md-block">
            @(Model.Items.Count) kayıt
        </div>
    </div>

    <form method="get" class="row g-2 align-items-end">
        <input type="hidden" name="studentId" value="@Model.StudentId" />

        <div class="col-6 col-md-4">
            <label class="form-label small mb-1">Başlangıç</label>
            <input type="date" class="form-control" name="from" value="@SafeDate(Model.From)" />
        </div>

        <div class="col-6 col-md-4">
            <label class="form-label small mb-1">Bitiş</label>
            <input type="date" class="form-control" name="to" value="@SafeDate(Model.To)" />
        </div>

        <div class="col-12 col-md-4 d-flex gap-2 justify-content-end">
            <button class="btn btn-outline-light flex-fill flex-md-grow-0" type="submit">Uygula</button>
            <a class="btn btn-outline-secondary flex-fill flex-md-grow-0"
               asp-action="Student"
               asp-route-studentId="@Model.StudentId">
                Temizle
            </a>
        </div>
    </form>
</section>

<section class="card-surface">
    <div class="d-flex justify-content-between align-items-center gap-2 mb-2">
        <h3 class="h6 mb-0">Kayıtlar</h3>

        @if (canWrite)
        {
            <a class="btn btn-sm btn-outline-primary d-none d-md-inline-flex"
               asp-action="Create"
               asp-route-studentId="@Model.StudentId">
                + Yeni Kayıt
            </a>
        }
    </div>

    @if (Model.Items.Count == 0)
    {
        <div class="text-center text-muted py-4">
            <div class="fw-semibold mb-1">Kayıt bulunamadı.</div>
            <div class="small mb-3">Seçilen tarih aralığında gelişim kaydı yok.</div>

            @if (canWrite)
            {
                <a class="btn btn-primary"
                   asp-action="Create"
                   asp-route-studentId="@Model.StudentId">
                    İlk Kaydı Ekle
                </a>
            }
        </div>
    }
    else
    {
        <!-- Desktop table -->
        <div class="table-responsive d-none d-md-block">
            <table class="table table-modern align-middle mb-0">
                <thead>
                    <tr>
                        <th>Tarih</th>
                        <th>Boy</th>
                        <th>Kilo</th>
                        <th>Yağ</th>
                        <th>Puanlar</th>
                        <th>Not</th>
                        <th class="text-end">İşlem</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var r in Model.Items)
                    {
                        <tr>
                            <td class="fw-semibold">@TrDate(r.RecordDate)</td>
                            <td>@(r.Height?.ToString() ?? "-")</td>
                            <td>@(r.Weight?.ToString() ?? "-")</td>
                            <td>@(r.BodyFatPercentage?.ToString() ?? "-")</td>
                            <td class="small text-muted">
                                T:@(r.TechnicalScore?.ToString() ?? "-"),
                                Ta:@(r.TacticalScore?.ToString() ?? "-"),
                                F:@(r.PhysicalScore?.ToString() ?? "-"),
                                M:@(r.MentalScore?.ToString() ?? "-")
                            </td>
                            <td class="small text-muted">@Short(r.CoachNotes, 60)</td>
                            <td class="text-end">
                                <a class="btn btn-sm btn-outline-light"
                                   asp-action="Details"
                                   asp-route-id="@r.Id">Detay</a>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>

        <!-- Mobile cards -->
        <div class="d-md-none vstack gap-3">
            @foreach (var r in Model.Items)
            {
                <div class="card border shadow-sm">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-start gap-2">
                            <div>
                                <div class="fw-semibold">@TrDate(r.RecordDate)</div>
                                <div class="small text-muted">
                                    Boy: @(r.Height?.ToString() ?? "-") · Kilo: @(r.Weight?.ToString() ?? "-") · Yağ: @(r.BodyFatPercentage?.ToString() ?? "-")
                                </div>
                            </div>
                            <a class="btn btn-sm btn-outline-primary"
                               asp-action="Details"
                               asp-route-id="@r.Id">Detay</a>
                        </div>

                        <div class="mt-3">
                            <div class="small text-muted mb-1">Puanlar</div>
                            <div class="d-flex flex-wrap gap-2 small">
                                <span class="badge bg-secondary">T: @(r.TechnicalScore?.ToString() ?? "-")</span>
                                <span class="badge bg-secondary">Ta: @(r.TacticalScore?.ToString() ?? "-")</span>
                                <span class="badge bg-secondary">F: @(r.PhysicalScore?.ToString() ?? "-")</span>
                                <span class="badge bg-secondary">M: @(r.MentalScore?.ToString() ?? "-")</span>
                            </div>
                        </div>

                        <div class="mt-3">
                            <div class="small text-muted mb-1">Koç Notu</div>
                            <div>@Short(r.CoachNotes, 120)</div>
                        </div>
                    </div>
                </div>
            }
        </div>
    }
</section>

@if (canWrite)
{
    <!-- Mobile sticky add -->
    <div class="d-md-none position-sticky bottom-0 start-0 end-0 bg-white border-top mt-4" style="z-index: 1020;">
        <div class="container-fluid py-2">
            <a class="btn btn-primary w-100"
               asp-action="Create"
               asp-route-studentId="@Model.StudentId">
                + Yeni Gelişim Kaydı
            </a>
        </div>
    </div>
}
