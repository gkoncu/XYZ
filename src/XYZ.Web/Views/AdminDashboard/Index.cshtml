@model AdminDashboardViewModel
@{
    ViewData["Title"] = "Yönetim Paneli";
    var daysLeft = Model.Stats.SubscriptionDaysRemaining;
}

<div class="d-flex justify-content-between align-items-end mb-3">
    <div>
        <h2 class="mb-1">Yönetim Paneli</h2>
        <div class="text-muted small">Hoş geldin, @Model.UserDisplayName</div>
    </div>

    @if (User.IsInRole("Admin") || User.IsInRole("SuperAdmin"))
    {
        <div class="d-flex gap-2">
            <a class="btn btn-sm btn-primary" asp-controller="Students" asp-action="Create">Yeni Öğrenci</a>
            <a class="btn btn-sm btn-outline-secondary" asp-controller="Announcements" asp-action="Create">Yeni Duyuru</a>
        </div>
    }
</div>

<div class="row g-3">
    <div class="col-12 col-sm-6 col-lg-3">
        <div class="card-surface p-3 h-100">
            <div class="text-muted small">Öğrenci</div>
            <div class="fs-4 fw-semibold mt-1">@Model.Stats.StudentCount</div>
        </div>
    </div>

    <div class="col-12 col-sm-6 col-lg-3">
        <div class="card-surface p-3 h-100">
            <div class="text-muted small">Sınıf</div>
            <div class="fs-4 fw-semibold mt-1">@Model.Stats.ClassCount</div>
        </div>
    </div>

    <div class="col-12 col-sm-6 col-lg-3">
        <div class="card-surface p-3 h-100">
            <div class="text-muted small">Bugünün dersleri</div>
            <div class="fs-4 fw-semibold mt-1">@Model.Stats.TodaySessionsCount</div>
        </div>
    </div>

    <div class="col-12 col-sm-6 col-lg-3">
        <div class="card-surface p-3 h-100">
            <div class="text-muted small">Yaklaşan dersler</div>
            <div class="fs-4 fw-semibold mt-1">@Model.Stats.UpcomingSessionsCount</div>
        </div>
    </div>
</div>

<div class="row g-3 mt-1">
    <div class="col-12 col-lg-4">
        <div class="card-surface p-3 h-100">
            <div class="text-muted small">Lisans</div>

            @if (Model.Stats.SubscriptionEndDate.HasValue)
            {
                <div class="fw-semibold mt-1">Bitiş: @Model.Stats.SubscriptionEndDate.Value.ToString("yyyy-MM-dd")</div>

                @if (daysLeft.HasValue)
                {
                    <div class="mt-2">
                        @if (daysLeft.Value <= 10)
                        {
                            <span class="badge-soft badge-soft-danger">Kalan: @daysLeft.Value gün</span>
                        }
                        else if (daysLeft.Value <= 30)
                        {
                            <span class="badge-soft badge-soft-warning">Kalan: @daysLeft.Value gün</span>
                        }
                        else
                        {
                            <span class="badge-soft badge-soft-success">Kalan: @daysLeft.Value gün</span>
                        }
                    </div>
                }
            }
            else
            {
                <div class="text-muted small mt-2">Lisans bilgisi bulunamadı.</div>
            }
        </div>
    </div>

    <div class="col-12 col-lg-8">
        <div class="card-surface p-3 h-100">
            <div class="text-muted small">Bugünün dersleri</div>
            <div class="fw-semibold">Yoklama almak için derse tıklayın</div>

            <div class="mt-3">
                @if (Model.Stats.TodaySessions is null || Model.Stats.TodaySessions.Count == 0)
                {
                    <div class="text-muted small">Bugün planlı ders yok.</div>
                }
                else
                {
                    <div class="list-group list-group-flush">
                        @foreach (var s in Model.Stats.TodaySessions)
                        {
                            <a class="list-group-item list-group-item-action d-flex justify-content-between align-items-center"
                               asp-controller="Attendance"
                               asp-action="Session"
                               asp-route-id="@s.SessionId">
                                <div>
                                    <div class="fw-semibold">@s.ClassName</div>
                                    <div class="text-muted small">
                                        @s.StartTime.ToString("HH\\:mm") - @s.EndTime.ToString("HH\\:mm")
                                        · @s.Title
                                        @if (!string.IsNullOrWhiteSpace(s.Location))
                                        {
                                            <span> · @s.Location</span>
                                        }
                                    </div>
                                </div>
                                <span class="badge-soft badge-soft-primary">Yoklama</span>
                            </a>
                        }
                    </div>
                }
            </div>
        </div>
    </div>
</div>

<div class="row g-3 mt-1">
    <div class="col-12 col-lg-6">
        <div class="card-surface p-3 h-100">
            <div class="text-muted small">Eksik belgeli öğrenciler</div>
            <div class="fw-semibold">Son 5</div>

            <div class="mt-3">
                @if (Model.Stats.IncompleteStudents is null || Model.Stats.IncompleteStudents.Count == 0)
                {
                    <div class="text-muted small">Eksik belgesi olan öğrenci yok.</div>
                }
                else
                {
                    <div class="list-group list-group-flush dashboard-list">
                        @foreach (var st in Model.Stats.IncompleteStudents)
                        {
                            <a class="list-group-item list-group-item-action d-flex justify-content-between align-items-center"
                               asp-controller="Documents"
                               asp-action="Student"
                               asp-route-studentId="@st.StudentId">
                                <div>
                                    <div class="fw-semibold">@st.FullName</div>
                                    <div class="text-muted small">Eksik: @st.MissingCount</div>
                                </div>
                                <span class="badge-soft badge-soft-warning">Aç</span>
                            </a>
                        }
                    </div>

                    <div class="text-muted small mt-2">
                        Toplam: <span class="fw-semibold">@Model.Stats.IncompleteStudentDocumentsCount</span>
                    </div>
                }
            </div>
        </div>
    </div>

    <div class="col-12 col-lg-6">
        <div class="card-surface p-3 h-100">
            <div class="text-muted small">Gecikmiş aidatı olan öğrenciler</div>
            <div class="fw-semibold">Son 5</div>

            <div class="mt-3">
                @if (Model.Stats.OverdueStudents is null || Model.Stats.OverdueStudents.Count == 0)
                {
                    <div class="text-muted small">Gecikmiş aidat yok.</div>
                }
                else
                {
                    <div class="list-group list-group-flush">
                        @foreach (var st in Model.Stats.OverdueStudents)
                        {
                            <a class="list-group-item list-group-item-action d-flex justify-content-between align-items-center"
                               asp-controller="Payments"
                               asp-action="Index"
                               asp-route-studentId="@st.StudentId"
                               asp-route-status="Overdue">
                                <div>
                                    <div class="fw-semibold">@st.FullName</div>
                                    <div class="text-muted small">
                                        Adet: @st.OverdueCount · Tutar: @st.OverdueAmount.ToString("C2")
                                        @if (st.OldestDueDate.HasValue)
                                        {
                                            <span> · En eski vade: @st.OldestDueDate.Value.ToString("yyyy-MM-dd")</span>
                                        }
                                    </div>
                                </div>
                                <span class="badge-soft badge-soft-danger">Aç</span>
                            </a>
                        }
                    </div>

                    <div class="text-muted small mt-2">
                        Toplam adet: <span class="fw-semibold">@Model.Stats.OverduePaymentsCount</span>
                        · Toplam tutar: <span class="fw-semibold">@Model.Stats.OverduePaymentsAmount.ToString("C2")</span>
                    </div>
                }
            </div>
        </div>
    </div>
</div>

<div class="row g-3 mt-1">
    <div class="col-12">
        <div class="card-surface p-3">
            <div class="text-muted small">Son duyurular</div>
            <div class="fw-semibold">Son 5</div>

            <div class="mt-3">
                @if (Model.Stats.RecentAnnouncements is null || Model.Stats.RecentAnnouncements.Count == 0)
                {
                    <div class="text-muted small">Yayında duyuru yok.</div>
                }
                else
                {
                    <div class="list-group list-group-flush">
                        @foreach (var a in Model.Stats.RecentAnnouncements)
                        {
                            <a class="list-group-item list-group-item-action d-flex justify-content-between align-items-center"
                               asp-controller="Announcements"
                               asp-action="Details"
                               asp-route-id="@a.Id">
                                <div>
                                    <div class="fw-semibold">@a.Title</div>
                                    <div class="text-muted small">@a.PublishDate.ToString("yyyy-MM-dd")</div>
                                </div>
                                <span class="badge-soft badge-soft-muted">Detay</span>
                            </a>
                        }
                    </div>
                }
            </div>
        </div>
    </div>
</div>
